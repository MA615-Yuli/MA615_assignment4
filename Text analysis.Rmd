---
title: "Text analysis"
author: "Yuli Jin"
date: "2021/11/24"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=F,message = F,echo=F)
#knitr::opts_chunk$set(echo = TRUE,out.width="0.9\\linewidth",dev="png",fig.align  = 'center')
knitr::opts_chunk$set(fig.width=6, fig.height=4,fig.align = "center") 
pacman::p_load(
tidyverse,
magrittr,
knitr,
gutenbergr,
tidytext,
sentimentr
)



```

## Task 1 Pick a book

I choose `The Burning Secret` as the my text analysis. This book was written by Zweug, Stefan.

```{r}

# gutenberg_metadata
# gutenberg_works(str_detect(author, "Zweig"))

my_book=gutenberg_download(c(45755))
#write.table(my_book,'testbook2.txt',row.names = F)

```

```{r}
library(tnum)
tnum.authorize("mssp1.bu.edu")
tnum.setSpace("test2")
source("Book2TN-v6A-1.R")

```




```{r}
#mybook<-read_lines('testbook.txt')
mybook<-read.table('testbookv2.txt',header = T)
# tnBooksFromLines(mybook$text, "Zweig/test1")
```

## TASK 2 bag of word analysis

First, I use three types of sentiment analysis methods AFINN, Bing and NRC to plot barplot to compare these methods. From the graph below, the AFINN and Bing method fits better. Most of the polt in `The Burning Secret` is in negative. In this book, While being treated for asthma at a country spa, an American diplomat's lonely 12-year-old son is befriended and infatuated by a suave, mysterious baron. But soon his adored friend heartlessly brushes him aside and turns his seductive attentions to his mother. The boy's jealousy and feelings of betrayal become uncontrollable. The story is set in Austria in the 1920s. That is to say, at the beginning of the book, the sentiment of the book is positive, but soon it converts into negative sentiment. However, it is difficult to identify which of the two methods is better. In the following task, I use Bing method to conduct further analysis.

```{r}
#my_book=mybook
tidy_books <- my_book %>%
  mutate(
    linenumber = row_number(),
    chapter = cumsum(str_detect(text, 
                                regex("^chapter [\\divxlc]", 
                                      ignore_case = TRUE)))) %>%
  unnest_tokens(word, text)
```


```{r}
afinn <- tidy_books %>% 
  inner_join(get_sentiments("afinn")) %>% 
  group_by(index = linenumber %/% 80) %>% 
  summarise(sentiment = sum(value)) %>% 
  mutate(method = "AFINN")

```



```{r}
afinn <- tidy_books %>% 
  inner_join(get_sentiments("afinn")) %>% 
  group_by(index = linenumber %/% 80) %>% 
  summarise(sentiment = sum(value)) %>% 
  mutate(method = "AFINN")

bing_and_nrc <- bind_rows(
  tidy_books %>% 
    inner_join(get_sentiments("bing")) %>%
    mutate(method = "Bing et al."),
  tidy_books %>% 
    inner_join(get_sentiments("nrc") %>% 
                 filter(sentiment %in% c("positive", 
                                         "negative"))
    ) %>%
    mutate(method = "NRC")) %>%
  count(method, index = linenumber %/% 80, sentiment) %>%
  pivot_wider(names_from = sentiment,
              values_from = n,
              values_fill = 0) %>% 
  mutate(sentiment = positive - negative)
```

```{r fig.cap="sentiment plot"}
bind_rows(afinn, 
          bing_and_nrc) %>%
  ggplot(aes(index, sentiment, fill = method)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~method, ncol = 1, scales = "free_y")+
  theme_bw()
```

```{r}
bing_word_counts <- tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  ungroup()
```

```{r fig.cap="negative & positive words count"}
bing_word_counts %>%
  group_by(sentiment) %>%
  slice_max(n, n = 10) %>% 
  ungroup() %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(n, word, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~sentiment, scales = "free_y") +
  labs(x = "Contribution to sentiment",
       y = NULL)
```
```{r fig.cap="word cloud"}
library(wordcloud)

tidy_books %>%
  anti_join(stop_words) %>%
  count(word) %>%
  with(wordcloud(word, n, max.words = 100))
```

```{r fig.cap='sentiment word cloud'}
library(reshape2)

tidy_books %>%
  inner_join(get_sentiments("bing")) %>%
  count(word, sentiment, sort = TRUE) %>%
  acast(word ~ sentiment, value.var = "n", fill = 0) %>%
  comparison.cloud(colors = c("gray20", "gray80"),
                   max.words = 100)
```

## task 3 sentence-level analysis


```{r}

 my_book %>%
  mutate(
    linenumber = row_number(),
    chapter = cumsum(str_detect(text, 
                                regex("^chapter [\\divxlc]", 
                                      ignore_case = TRUE)))) %>%
  unnest_tokens(word, text)

my_book_sentences <- tibble(my_book) %>% mutate(
    linenumber = row_number(),
    chapter = cumsum(str_detect(text, 
                                regex("^chapter [\\divxlc]", 
                                      ignore_case = TRUE)))) %>% 
  unnest_tokens(sentence, text, token = "sentences")

my_book_sentences


sentences_out<-my_book_sentences %>%
    dplyr::mutate(sentence_split = get_sentences(sentence)) %$%
    sentiment_by(sentence_split, list(chapter))

plot(sentences_out)

```


```{r eval=F}
tnum.getDBPathList(taxonomy="subject", levels=2)

#tnBooksFromLines(time_machine$text, "wells/hw_time_1")

q20<-tnum.query(query="zweig/test1# has *",max=100000)
df20 <- tnum.objectsToDf(q20)
df20 %>% view()
q24<- tnum.query('zweig/test1/heading# has *',max=60)
df24 <- tnum.objectsToDf(q24)
df24 %>% view()

q26<- tnum.query('zweig/test1# has text',max=6000)
df26 <- tnum.objectsToDf(q26)
df26 %>% view()


# q24<- tnum.query('wells9/hw9/heading# has *',max=6000)
# df24 <- tnum.objectsToDf(q24)
# 
# q22<-tnum.query('wells9/hw9/heading:0022# has *')
# df22<-tnum.objectsToDf(q22)
# ord_ch1 <-unlist( tnum.query('wells9/hw9/heading:0022# has ordinal') )
# ord_ch2<-unlist(tnum.query('wells9/hw9/heading:0023# has ordinal'))
# 
# q25<-tnum.query('wells9/hw9/heading:0023# has *')
# df25<-tnum.objectsToDf(q25)
#   
# ch1_txt<-tnum.query('wells9/hw9/section:0022/paragraph:0002# has text',max=30)
# ch1_txt_df<-tnum.objectsToDf(ch1_txt)
# ch1_txt_df$string.value
# 
# ch2_txt<-tnum.query('wells9/hw9/section:0022/paragraph:0002/sentence:# has *',max=30)
# 
# ch2_txt_df<-tnum.objectsToDf(ch2_txt)
# ch2_txt_df$string.value
# 
# length(ch2_txt_df$string.value)
# 
# 
# q21<-tnum.query('wells9/hw9/section:0022/paragraph:0001/# has *',max=30)
# df21<-tnum.objectsToDf(q21)
# 
# library(sentimentr)
# 
# my_book$text[105:145] %>% sentiment()
```

